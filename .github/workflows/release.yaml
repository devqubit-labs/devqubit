name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      package:
        description: "Which package to publish (bootstrap helper). Use 'all' for normal releases."
        required: true
        default: "all"
        type: choice
        options:
          - devqubit-engine
          - devqubit
          - devqubit-ui
          - devqubit-qiskit
          - devqubit-qiskit-runtime
          - devqubit-pennylane
          - devqubit-cirq
          - devqubit-braket
          - all

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
          enable-cache: true

      - run: uv sync --all-packages --all-extras --dev --locked
      - run: uv run pytest
      - run: uv run python -m pip install --upgrade build

      - name: Verify tag matches all package versions (tag runs only)
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: |
          uv run python - << 'PY'
          import os, sys, pathlib, tomllib
          tag = os.environ["GITHUB_REF_NAME"]
          ver = tag[1:] if tag.startswith("v") else tag
          pyprojects = [pathlib.Path("pyproject.toml")] + sorted(pathlib.Path("packages").glob("*/pyproject.toml"))
          bad = []
          for p in pyprojects:
            v = tomllib.loads(p.read_text(encoding="utf-8")).get("project", {}).get("version")
            if v != ver:
              bad.append((str(p), v))
          if bad:
            for p, v in bad:
              print(f"Version mismatch: {p}: {v!r} != {ver!r}")
            sys.exit(1)
          print("OK:", ver)
          PY

      - name: Build all distributions into per-package dirs
        run: |
          uv run python - << 'PY'
          import pathlib, tomllib, subprocess, sys
          root = pathlib.Path(".").resolve()
          dist = root / "dist"
          dist.mkdir(exist_ok=True)

          def name(pp):
            return tomllib.loads(pp.read_text(encoding="utf-8"))["project"]["name"]

          # root
          root_name = name(root / "pyproject.toml")
          (dist / root_name).mkdir(parents=True, exist_ok=True)
          subprocess.check_call([sys.executable, "-m", "build", "--outdir", str(dist / root_name), str(root)])

          # members
          for pp in sorted((root / "packages").glob("*/pyproject.toml")):
            pkg = pp.parent
            n = name(pp)
            (dist / n).mkdir(parents=True, exist_ok=True)
            subprocess.check_call([sys.executable, "-m", "build", "--outdir", str(dist / n), str(pkg)])
          PY

      - uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

  publish:
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    strategy:
      fail-fast: false
      matrix:
        package:
          - devqubit-engine
          - devqubit
          - devqubit-ui
          - devqubit-qiskit
          - devqubit-qiskit-runtime
          - devqubit-pennylane
          - devqubit-cirq
          - devqubit-braket

    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && (inputs.package == 'all' || inputs.package == matrix.package)) }}

    environment:
      name: pypi
      url: https://pypi.org/project/${{ matrix.package }}/

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/${{ matrix.package }}
          skip-existing: true
